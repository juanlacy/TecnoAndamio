<div class="form-container">
  <div class="header">
    <button mat-icon-button (click)="onCancel()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>{{ isEditMode() ? 'Editar Cliente' : 'Nuevo Cliente' }}</h1>
  </div>

  @if (loading()) {
    <app-loading [message]="isEditMode() ? 'Cargando cliente...' : 'Guardando...'"></app-loading>
  }

  @if (!loading()) {
    <mat-card class="form-card">
      <mat-card-content>
        <form [formGroup]="clienteForm" (ngSubmit)="onSubmit()">
          <!-- Sección: Información Básica -->
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>business_center</mat-icon>
              Información Básica
            </h3>

          <!-- RUT -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>RUT</mat-label>
            <input
              matInput
              formControlName="rut"
              placeholder="12.345.678-9"
              (input)="onRutInput()"
              [class.invalid]="clienteForm.get('rut')?.invalid && clienteForm.get('rut')?.touched"
            >
            <mat-icon matSuffix>badge</mat-icon>
            @if (clienteForm.get('rut')?.invalid && clienteForm.get('rut')?.touched) {
              <mat-error>{{ getErrorMessage('rut') }}</mat-error>
            }
            <mat-hint>Ingrese el RUT sin puntos ni guión, se formateará automáticamente</mat-hint>
          </mat-form-field>

          <!-- Empresa -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Empresa</mat-label>
            <input
              matInput
              formControlName="empresa"
              placeholder="Empresa Constructora S.A."
              [class.invalid]="clienteForm.get('empresa')?.invalid && clienteForm.get('empresa')?.touched"
            >
            <mat-icon matSuffix>business</mat-icon>
            @if (clienteForm.get('empresa')?.invalid && clienteForm.get('empresa')?.touched) {
              <mat-error>{{ getErrorMessage('empresa') }}</mat-error>
            }
          </mat-form-field>

          <!-- Rubro -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Rubro</mat-label>
            <input
              matInput
              formControlName="rubro"
              placeholder="Construcción, Inmobiliario, etc."
              [class.invalid]="clienteForm.get('rubro')?.invalid && clienteForm.get('rubro')?.touched"
            >
            <mat-icon matSuffix>category</mat-icon>
            @if (clienteForm.get('rubro')?.invalid && clienteForm.get('rubro')?.touched) {
              <mat-error>{{ getErrorMessage('rubro') }}</mat-error>
            }
            <mat-hint>Opcional - Sector o rubro de la empresa</mat-hint>
          </mat-form-field>
          </div>

          <!-- Sección: Información de Contacto -->
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>contact_mail</mat-icon>
              Información de Contacto
            </h3>

          <!-- Email Empresa -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Email Empresa</mat-label>
            <input
              matInput
              type="email"
              formControlName="correo_empresa"
              placeholder="contacto@empresa.com"
              [class.invalid]="clienteForm.get('correo_empresa')?.invalid && clienteForm.get('correo_empresa')?.touched"
            >
            <mat-icon matSuffix>email</mat-icon>
            @if (clienteForm.get('correo_empresa')?.invalid && clienteForm.get('correo_empresa')?.touched) {
              <mat-error>{{ getErrorMessage('correo_empresa') }}</mat-error>
            }
            <mat-hint>Opcional - Email de contacto de la empresa</mat-hint>
          </mat-form-field>

          <!-- Dirección -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Dirección</mat-label>
            <textarea
              matInput
              formControlName="direccion"
              placeholder="Av. Libertador 1234, Santiago"
              rows="3"
            ></textarea>
            <mat-icon matSuffix>location_on</mat-icon>
            <mat-hint>Opcional</mat-hint>
          </mat-form-field>
          </div>

          <!-- Sección: Estado -->
          <div class="form-section">
            <h3 class="section-title">
              <mat-icon>toggle_on</mat-icon>
              Estado del Cliente
            </h3>

          <!-- Activo -->
          <div class="toggle-field">
            <mat-slide-toggle formControlName="activo" color="primary">
              Cliente Activo
            </mat-slide-toggle>
            <span class="toggle-hint">
              <mat-icon>info</mat-icon>
              Los clientes inactivos no aparecerán en los selectores
            </span>
          </div>
          </div>

          <!-- Botones -->
          <div class="form-actions">
            <button
              mat-raised-button
              type="button"
              (click)="onCancel()"
            >
              Cancelar
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="clienteForm.invalid || loading()"
            >
              <mat-icon>save</mat-icon>
              {{ isEditMode() ? 'Actualizar' : 'Crear' }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
