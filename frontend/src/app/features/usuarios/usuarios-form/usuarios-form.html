<div class="form-container-compact">
  <div class="header-compact">
    <button mat-icon-button (click)="onCancel()" class="back-btn">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h2>{{ isEditMode() ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>
  </div>

  @if (loading()) {
    <app-loading [message]="isEditMode() ? 'Cargando...' : 'Guardando...'"></app-loading>
  }

  @if (!loading()) {
    <mat-card class="form-card-compact">
      <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()">
        <!-- Grid de 2 columnas para campos principales -->
        <div class="form-grid">
          <!-- Nombre -->
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Nombre</mat-label>
            <input matInput formControlName="nombre" placeholder="Nombre completo">
            <mat-icon matSuffix>person</mat-icon>
            @if (usuarioForm.get('nombre')?.invalid && usuarioForm.get('nombre')?.touched) {
              <mat-error>{{ getErrorMessage('nombre') }}</mat-error>
            }
          </mat-form-field>

          <!-- Email -->
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Email</mat-label>
            <input matInput type="email" formControlName="email" placeholder="usuario@ejemplo.com">
            <mat-icon matSuffix>email</mat-icon>
            @if (usuarioForm.get('email')?.invalid && usuarioForm.get('email')?.touched) {
              <mat-error>{{ getErrorMessage('email') }}</mat-error>
            }
          </mat-form-field>

          <!-- Contraseña (solo en modo crear, o separado en editar) -->
          @if (!isEditMode()) {
            <mat-form-field appearance="outline" class="compact-field">
              <mat-label>Contraseña</mat-label>
              <input matInput type="password" formControlName="password" placeholder="Mín. 6 caracteres">
              <mat-icon matSuffix>lock</mat-icon>
              @if (usuarioForm.get('password')?.invalid && usuarioForm.get('password')?.touched) {
                <mat-error>{{ getErrorMessage('password') }}</mat-error>
              }
            </mat-form-field>
          }

          <!-- Rol -->
          <mat-form-field appearance="outline" class="compact-field">
            <mat-label>Rol</mat-label>
            <mat-select formControlName="rol">
              @for (rol of roles; track rol.value) {
                <mat-option [value]="rol.value">
                  {{ rol.label }}
                </mat-option>
              }
            </mat-select>
            <mat-icon matSuffix>badge</mat-icon>
          </mat-form-field>
        </div>

        <!-- Toggle de estado -->
        <div class="toggle-compact">
          <mat-slide-toggle formControlName="activo" color="primary">
            <span class="toggle-label">
              <mat-icon>{{ usuarioForm.get('activo')?.value ? 'check_circle' : 'cancel' }}</mat-icon>
              Usuario {{ usuarioForm.get('activo')?.value ? 'Activo' : 'Inactivo' }}
            </span>
          </mat-slide-toggle>
        </div>

        <!-- Botones de acción -->
        <div class="actions-compact">
          <button type="button" mat-button (click)="onCancel()">
            Cancelar
          </button>
          <button type="submit" mat-raised-button color="primary" [disabled]="usuarioForm.invalid">
            <mat-icon>{{ isEditMode() ? 'save' : 'add' }}</mat-icon>
            {{ isEditMode() ? 'Guardar' : 'Crear' }}
          </button>
        </div>
      </form>
    </mat-card>
  }
</div>
